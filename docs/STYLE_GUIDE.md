# Руководство по стилю кода «Решалы»

Этот документ — железный стандарт оформления кода и использования внутренних хелперов проекта. **Все новые модули и плагины обязаны следовать этим правилам без исключений.**

Цель — поддерживать код единообразным, читаемым и предсказуемым.

---

## 1. Стиль и структура кода

- **Шелл:** Все скрипты должны использовать `#!/bin/bash`.
- **Синтаксис:**
  - Для тестов предпочитайте `[[ ... ]]` вместо `[ ... ]`.
  - Для подстановки команд используйте `$(...)` вместо обратных кавычек (`` `...` ``).
- **Переменные:**
  - Всегда объявляйте переменные внутри функций с помощью `local`.
  - Используйте синтаксис `${variable_name}` для большей ясности и во избежание проблем с `set -u`.
- **Именование функций:**
  - Используйте `snake_case` (например, `show_my_menu`).
  - Внутренние (приватные) хелперы, не предназначенные для вызова из других модулей, должны начинаться с подчеркивания (например, `_helper_function`).

---

## 2. Генерация меню и UI

Все интерактивные меню должны генерироваться с помощью стандартных хелперов из `modules/core/common.sh`.

### 2.1. Метаданные для главного меню

Для добавления пункта в главное меню используется блок метаданных в шапке файла модуля:
```bash
# MENU_PARENT: main
# MENU_ORDER: 20
# MENU_GROUP_ID: 1
# MENU_TITLE: Мой модуль
# MENU_KEY: m
# MENU_ENTRY: show_my_menu
```
- **`MENU_ORDER`**: для сортировки.
- **`MENU_GROUP_ID`**: для визуальной группировки пунктов (пункты с одинаковым ID отображаются без отступа).

### 2.2. Структура функции меню

```bash
show_my_menu() {
    enable_graceful_ctrlc
    while true; do
        clear
        menu_header "Заголовок моего меню"
        printf_description "Это меню делает то-то и то-то."

        printf_menu_option "1" "Первый пункт"
        printf_menu_option "2" "Второй пункт"
        printf_menu_option "b" "Назад"

        local choice
        choice=$(safe_read "Ваш выбор: ") || break

        case "$choice" in
            1) _do_something ;;
            [bB]) break ;;
        esac
    done
    disable_graceful_ctrlc
}
```
- **Цикл:** Всегда `while true`, обернутый в `enable_graceful_ctrlc` / `disable_graceful_ctrlc` для корректной обработки `Ctrl+C`.
- **Очистка экрана:** Цикл должен начинаться с `clear`.
- **Хелперы:** Используйте `menu_header`, `printf_description` и `printf_menu_option`.

---

## 3. Взаимодействие с пользователем

### 3.1. Вывод сообщений

Никогда не используйте `echo` для сообщений пользователю. Используйте стандартные хелперы:
- `info "Обычное сообщение"`
- `ok "Операция выполнена успешно"`
- `warn "Предупреждение о чем-либо"`
- `err "Произошла ошибка"` (автоматически добавляет паузу)

### 3.2. Ввод данных

- **Простой ввод:** `my_var=$(safe_read "Введите значение:") || break`
- **Подтверждение (Да/Нет):** `if ask_yes_no "Вы уверены?"; then ... fi`
- **Непустой ввод:** `my_var=$(ask_non_empty "Введите имя:") || break`
- **Число в диапазоне:** `my_port=$(ask_number_in_range "Введите порт" 1 65535) || break`
- **Пауза:** `wait_for_enter`

### 3.3. Цвета

- Все цвета определены как переменные `${C_*}` в `modules/core/common.sh` (например, `${C_GREEN}`, `${C_GRAY}`).
- **Запрещено** использовать "сырые" ANSI-коды (`\033[...`).
- Для сброса цвета всегда используйте `${C_RESET}`.

---

## 4. Работа с системой

- **Выполнение команд:**
  - Всегда используйте `run_cmd` для системных команд, требующих `sudo` (`apt`, `systemctl`, `sed` для системных файлов).
  - `run_cmd systemctl restart nginx`
- **Логирование:**
  - Пишите в лог-файл проекта через `log "Мое сообщение для лога"`.
- **Конфигурация:**
  - Читайте и пишите в `config/reshala.conf` только через `get_config_var "KEY"` и `set_config_var "KEY" "VALUE"`.
- **Зависимости:**
  - Для проверки и установки утилит (`curl`, `jq`) используйте `ensure_dependencies "curl" "jq"`.

---

## 5. Плагины

- **Виджеты дашборда:** должны выводить строки в формате `Метка: Значение`.
- **Команды Skynet:** должны иметь заголовок `# TITLE: ...`.

Более подробная информация о создании плагинов находится в файле `docs/GUIDE_SKYNET_WIDGETS.md`.
