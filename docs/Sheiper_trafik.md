
# üö¶ –®–µ–π–ø–µ—Ä —Ç—Ä–∞—Ñ–∏–∫–∞

–ö–∞–∂–¥–æ–º—É **—É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É IP-–∞–¥—Ä–µ—Å—É** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è **—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ª–∏–º–∏—Ç**.

***

## ‚úÖ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```
–ü–æ—Ä—Ç: 8443
–õ–∏–º–∏—Ç DL (User): 4 Mbit/s
–õ–∏–º–∏—Ç UL (User): 4 Mbit/s
–û–±—â–∏–π –ª–∏–º–∏—Ç –ø–æ—Ä—Ç–∞: 10000 Mbit/s (–±–µ–∑–ª–∏–º–∏—Ç)
Max users: 256
```


***

## üìä –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: **–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω**

```
IP: 1.2.3.4
‚îî‚îÄ Download: 4 Mbit/s ‚úÖ
‚îî‚îÄ Upload:   4 Mbit/s ‚úÖ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **—Ä–æ–≤–Ω–æ 4 Mbit/s** –≤ –∫–∞–∂–¥–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.

***

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: **–ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–æ 256)**

```
IP: 1.2.3.4   ‚Üí DL: 4 Mbit/s, UL: 4 Mbit/s ‚úÖ
IP: 5.6.7.8   ‚Üí DL: 4 Mbit/s, UL: 4 Mbit/s ‚úÖ
IP: 9.10.11.12 ‚Üí DL: 4 Mbit/s, UL: 4 Mbit/s ‚úÖ
...
IP: 50 users  ‚Üí –ö–∞–∂–¥—ã–π: 4 Mbit/s ‚úÖ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π IP –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–∏ 4 Mbit/s.

***

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: **–ë–æ–ª–µ–µ 256 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```
Users 1-256:   –ö–∞–∂–¥—ã–π 4 Mbit/s ‚úÖ
User 257+:     –ü–æ–ø–∞–¥–∞—é—Ç –≤ "default class" (–±–µ–∑–ª–∏–º–∏—Ç) ‚ö†Ô∏è
```

**–ü—Ä–æ–±–ª–µ–º–∞:** U32 hash –∏–º–µ–µ—Ç **–∫–æ–ª–ª–∏–∑–∏–∏** ‚Äî –µ—Å–ª–∏ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö IP –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ö–µ—à, –æ–Ω–∏ **–¥–µ–ª—è—Ç** –æ–¥–∏–Ω –∫–ª–∞—Å—Å.

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏:**

- –ü—Ä–∏ 256 buckets –∏ 256 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö: **~63%** —à–∞–Ω—Å –∫–æ–ª–ª–∏–∑–∏–∏
- –ü—Ä–∏ 256 buckets –∏ 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö: **~30%** —à–∞–Ω—Å –∫–æ–ª–ª–∏–∑–∏–∏

***

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. **–õ–∏–º–∏—Ç PER-IP, –∞ –Ω–µ per-connection**

**–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –æ–¥–Ω–æ–≥–æ IP:**

```
IP: 1.2.3.4
‚îú‚îÄ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 1 (VPN) ‚Üí \
‚îú‚îÄ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 2 (VPN) ‚Üí ‚îú‚îÄ –°—É–º–º–∞—Ä–Ω–æ: 4 Mbit/s ‚úÖ
‚îî‚îÄ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 3 (VPN) ‚Üí /
```

**–í–µ—Ä–¥–∏–∫—Ç:** –ï—Å–ª–∏ –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ –æ—Ç–∫—Ä—ã–ª 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö VPN-—Ç—É–Ω–Ω–µ–ª—è —Å **–æ–¥–Ω–æ–≥–æ IP** ‚Äî –æ–Ω–∏ **–¥–µ–ª—è—Ç** 4 Mbit/s –º–µ–∂–¥—É —Å–æ–±–æ–π.

***

### 2. **–†–∞–∑–Ω—ã–µ IP = —Ä–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–¥–∞–∂–µ –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫)**

**–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ NAT:**

```
IP: 1.2.3.4 (WiFi)  ‚Üí 4 Mbit/s ‚úÖ
IP: 5.6.7.8 (Mobile) ‚Üí 4 Mbit/s ‚úÖ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç!)
```

**–í–µ—Ä–¥–∏–∫—Ç:** –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è —Å WiFi –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Äî –ø–æ–ª—É—á–∏—Ç **–Ω–æ–≤—ã–π –ª–∏–º–∏—Ç**.

***

### 3. **–û–±—â–∏–π –ª–∏–º–∏—Ç –ø–æ—Ä—Ç–∞ (TOTAL_LIMIT)**

–ï—Å–ª–∏ —Ç—ã —É–∫–∞–∑–∞–ª `TOTAL_LIMIT=100mbit`:

```
50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó 4 Mbit/s = 200 Mbit/s (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏)
–ù–û: –û–±—â–∏–π –ª–∏–º–∏—Ç = 100 Mbit/s

–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:
- –ü–µ—Ä–≤—ã–µ ~25 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –ø–æ–ª—É—á–∞—é—Ç –ø–æ–ª–Ω—ã–µ 4 Mbit/s
- –û—Å—Ç–∞–ª—å–Ω—ã–µ 25: –¥–µ–ª—è—Ç –æ—Å—Ç–∞–≤—à—É—é—Å—è –ø–æ–ª–æ—Å—É (~1-2 Mbit/s –∫–∞–∂–¥—ã–π)
```

**–í–µ—Ä–¥–∏–∫—Ç:** `TOTAL_LIMIT` ‚Äî —ç—Ç–æ **–∂—ë—Å—Ç–∫–∏–π –ø–æ—Ç–æ–ª–æ–∫** –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–º–µ—Å—Ç–µ.

***

## üî¨ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞

### –ö–∞–∫ TC –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∫–ª–∞—Å—Å –∫–∞–∂–¥–æ–º—É –ø–∞–∫–µ—Ç—É:

```bash
1. –ü–∞–∫–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å IP: 1.2.3.4, –ø–æ—Ä—Ç: 8443
2. TC –≤—ã—á–∏—Å–ª—è–µ—Ç hash: last_byte(1.2.3.4) % 256 = 4
3. –ü–∞–∫–µ—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –≤ bucket #4 ‚Üí Class ID: 1:1004
4. –ö–ª–∞—Å—Å 1:1004 –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç: rate 4mbit ceil 4mbit
5. –ü–∞–∫–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 4 Mbit/s
```

**–í–∞–∂–Ω–æ:** Hash —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç **–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞–π—Ç–∞ IP**:

```
IP: 192.168.1.100 ‚Üí Hash: 100 % 256 = 100 ‚Üí Bucket #100
IP: 10.0.0.100    ‚Üí Hash: 100 % 256 = 100 ‚Üí Bucket #100 (–∫–æ–ª–ª–∏–∑–∏—è!)
```


***

## üìä –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: VPN —Å–µ—Ä–≤–µ—Ä —Å 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

```
–ü–æ—Ä—Ç: 8443
User DL: 4 Mbit/s
User UL: 4 Mbit/s
Total: 10 Gbit/s (–±–µ–∑–ª–∏–º–∏—Ç)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
–ö–∞–∂–¥—ã–π –∏–∑ 50 —é–∑–µ—Ä–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç:
‚úÖ Download: 4 Mbit/s
‚úÖ Upload:   4 Mbit/s
–û–±—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: 50 √ó 4 = 200 Mbit/s (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö Total Limit)
```


***

### –ü—Ä–∏–º–µ—Ä 2: –ñ—ë—Å—Ç–∫–∏–π –æ–±—â–∏–π –ª–∏–º–∏—Ç

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

```
–ü–æ—Ä—Ç: 8443
User DL: 10 Mbit/s
User UL: 10 Mbit/s
Total: 100 Mbit/s (!!!)
```

**–°—Ü–µ–Ω–∞—Ä–∏–π:**

```
5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –ö–∞–∂–¥—ã–π —Ö–æ—á–µ—Ç: 10 Mbit/s
- –°—É–º–º–∞—Ä–Ω–æ —Ö–æ—Ç—è—Ç: 50 Mbit/s
‚úÖ –ü–æ–ª—É—á–∞—é—Ç: 10 Mbit/s –∫–∞–∂–¥—ã–π (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö Total)

20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –ö–∞–∂–¥—ã–π —Ö–æ—á–µ—Ç: 10 Mbit/s
- –°—É–º–º–∞—Ä–Ω–æ —Ö–æ—Ç—è—Ç: 200 Mbit/s
‚ùå –ü–æ–ª—É—á–∞—é—Ç: ~5 Mbit/s –∫–∞–∂–¥—ã–π (Total –¥–µ–ª–∏—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É)
```

**–í–µ—Ä–¥–∏–∫—Ç:** –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ `TOTAL_LIMIT` ‚Äî HTB **–¥–µ–ª–∏—Ç** –ø–æ–ª–æ—Å—É –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.

***

## üéØ –ì–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ì–∞—Ä–∞–Ω—Ç–∏—è | –£—Å–ª–æ–≤–∏–µ |
| :-- | :-- | :-- |
| **Per-IP –ª–∏–º–∏—Ç** | ‚úÖ –î–∞ | –ü–æ–∫–∞ IP < 256 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —é–∑–µ—Ä–æ–≤** | ‚úÖ –î–∞ | –ö–∞–∂–¥—ã–π IP –≤ —Å–≤–æ—ë–º bucket-–µ |
| **Total Limit** | ‚úÖ –ñ—ë—Å—Ç–∫–∏–π | –ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç –æ–±—â–∏–π –ª–∏–º–∏—Ç |
| **Burst (–≤—Å–ø–ª–µ—Å–∫–∏)** | ‚ö†Ô∏è –ù–µ—Ç | `ceil = rate` (–Ω–µ—Ç –∑–∞–ø–∞—Å–∞) |
| **Hash collision** | ‚ùå –í–æ–∑–º–æ–∂–Ω–∞ | –ü—Ä–∏ 256+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö IP |


***

**–î–∞, –∫–∞–∂–¥–æ–º—É IP –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —É–∫–∞–∑–∞–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å**, –Ω–æ:

1. ‚úÖ **–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π < 256** ‚Äî –∫–∞–∂–¥—ã–π –ø–æ–ª—É—á–∞–µ—Ç **—Ä–æ–≤–Ω–æ** —Å–≤–æ–π –ª–∏–º–∏—Ç
2. ‚ö†Ô∏è **–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π > 256** ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –∫–æ–ª–ª–∏–∑–∏–∏ (–¥–≤–∞ IP –≤ –æ–¥–Ω–æ–º bucket)
3. ‚úÖ **TOTAL_LIMIT** ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø–æ—Ç–æ–ª–æ–∫ –¥–ª—è –≤—Å–µ—Ö –≤–º–µ—Å—Ç–µ
4. ‚úÖ **–†–∞–∑–Ω—ã–µ IP** –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ = —Ä–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã

**–î–ª—è —Ç–≤–æ–µ–≥–æ VPN (–æ–±—ã—á–Ω–æ < 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —é–∑–µ—Ä–æ–≤)** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç **–∏–¥–µ–∞–ª—å–Ω–æ**  üöÄ